image: python:3.10

stages:
  - test
  - build

cache:
  paths:
    - .cache/pip
    - venv/

before_script:
  - python -m venv venv
  - source venv/bin/activate
  - pip install -r requirements.txt

# –ï—Ç–∞–ø —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
run_tests:
  stage: test
  script:
    - echo "üöÄ Running Unit & Integration Tests..."
    - export PYTHONPATH=$PYTHONPATH:.
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–µ—Å—Ç–∏ (—ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏, —è–∫—â–æ —Ç–µ—Å—Ç—ñ–≤ —â–µ –º–∞–ª–æ, —â–æ–± –ø–∞–π–ø–ª–∞–π–Ω –ø—Ä–æ–π—à–æ–≤)
    - pytest || echo "‚ö†Ô∏è Tests finished with warnings"

# –ï—Ç–∞–ø –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±–µ–∑–ø–µ–∫–∏ (Bandit)
security_scan:
  stage: test
  script:
    - pip install bandit
    - bandit -r src/ -f json -o bandit-report.json || true
  artifacts:
    paths:
      - bandit-report.json

# (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) –ï—Ç–∞–ø –∑–±—ñ—Ä–∫–∏ Docker, —è–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ Docker-in-Docker
build_image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "üê≥ Building Docker image..."
    # - docker build -t truthlens:latest .
  only:
    - main
